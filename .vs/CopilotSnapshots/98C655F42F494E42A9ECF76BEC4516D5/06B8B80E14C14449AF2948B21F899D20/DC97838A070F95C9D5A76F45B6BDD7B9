using DAJDAJ.DataAccess;
using DAJDAJ.DataAccess.Implementation;
using DAJDAJ.Entities.Models;
using DAJDAJ.Entities.Repositories;
using DAJDAJ.Entities.ViewModels;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;

namespace DAJDAJ.Web.Areas.Admin.Controllers
{
    [Area("Admin")]
    public class ProductController : Controller
    {
        private readonly IUntiOfWork _untiOfWork;
        private readonly IWebHostEnvironment _webHostEnvironment;
        private readonly ApplicationDbContext _context;
        
        public ProductController(IUntiOfWork untiOfWork, IWebHostEnvironment webHostEnvironment, ApplicationDbContext context)
        {
            _untiOfWork = untiOfWork;
            _webHostEnvironment = webHostEnvironment;
            _context = context;
        }

        public IActionResult Index()
        {
            return View();
        }

        public IActionResult GetData()
        {
            var products = _untiOfWork.Product.GetAll(Includeword: "Category");
            return Json(new { data = products });
        }

        [HttpGet]
        public IActionResult Create()
        {
            ProductVM productVM = new ProductVM()
            {
                product = new Product(),
                categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString()
                }),
                AvailableColors = GetAvailableColors()
            };

            return View(productVM);
        }

        [HttpPost]
        [AutoValidateAntiforgeryToken]
        public IActionResult Create(ProductVM productVM, IFormFile Img)
        {
            if (!ModelState.IsValid)
            {
                var errors = ModelState.Values.SelectMany(v => v.Errors).Select(e => e.ErrorMessage).ToList();
                TempData["Error"] = "يرجى تصحيح الأخطاء التالية: " + string.Join(", ", errors);
                
                productVM.categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString()
                });
                productVM.AvailableColors = GetAvailableColors();

                return View(productVM);
            }

            try
            {
                string RootPath = _webHostEnvironment.WebRootPath;
                
                if (Img != null && Img.Length > 0)
                {
                    var mainImagePath = SaveImage(Img, RootPath);
                    productVM.product.Img = mainImagePath;
                }

                var productImages = ProcessAdditionalImages(productVM.Images, productVM.ImageColors, RootPath);
                productVM.product.ProductImages = productImages;

                if (productVM.product.IsOneSize)
                {
                    productVM.product.Size = "One Size";
                }

                _untiOfWork.Product.Add(productVM.product);
                _untiOfWork.Complete();
                
                TempData["Success"] = "تم إنشاء المنتج بنجاح";
                return RedirectToAction("Index");
            }
            catch (Exception ex)
            {
                TempData["Error"] = "حدث خطأ أثناء إنشاء المنتج: " + ex.Message;
                
                productVM.categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString()
                });
                productVM.AvailableColors = GetAvailableColors();

                return View(productVM);
            }
        }

        [HttpGet]
        public IActionResult Edit(int? id)
        {
            System.Diagnostics.Debug.WriteLine($"=== Edit GET Started - ID: {id} ===");
            
            if (id == null || id == 0)
            {
                TempData["Error"] = "معرف المنتج غير صحيح";
                return RedirectToAction("Index");
            }

            // Use Entity Framework directly for more reliable loading
            var product = _context.products
                .Include(p => p.Category)
                .Include(p => p.ProductImages)
                .FirstOrDefault(p => p.Id == id);

            if (product == null)
            {
                TempData["Error"] = "المنتج غير موجود";
                return RedirectToAction("Index");
            }

            System.Diagnostics.Debug.WriteLine($"Product found: {product.Name}");
            System.Diagnostics.Debug.WriteLine($"Main Image: {product.Img}");
            System.Diagnostics.Debug.WriteLine($"ProductImages Count: {product.ProductImages?.Count ?? 0}");

            if (product.ProductImages != null)
            {
                foreach (var img in product.ProductImages)
                {
                    System.Diagnostics.Debug.WriteLine($"ProductImage: {img.ImagePath}, Color: {img.Color}");
                }
            }

            ProductVM productVM = new ProductVM()
            {
                product = product,
                categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString(),
                    Selected = x.Id == product.CategoryId
                }),
                AvailableColors = GetAvailableColors()
            };

            // Use the enhanced method to populate existing image data
            productVM.PopulateExistingImageData();
            
            System.Diagnostics.Debug.WriteLine($"After PopulateExistingImageData:");
            System.Diagnostics.Debug.WriteLine($"ImageColors count: {productVM.ImageColors.Count}");
            System.Diagnostics.Debug.WriteLine($"ExistingImagePaths count: {productVM.ExistingImagePaths.Count}");
            System.Diagnostics.Debug.WriteLine($"ExistingImageIds count: {productVM.ExistingImageIds.Count}");

            System.Diagnostics.Debug.WriteLine($"=== Edit GET Complete - ViewModel created ===");
            return View(productVM);
        }

        [HttpPost]
        [AutoValidateAntiforgeryToken]
        public IActionResult Edit(ProductVM productVM, IFormFile Img, List<string> ExistingImagePaths, List<int> ExistingImageIds, List<string> CurrentImageColors)
        {
            ModelState.Remove("product.Img");
            ModelState.Remove("Img");

            System.Diagnostics.Debug.WriteLine($"=== Edit POST Started - Product ID: {productVM.product.Id} ===");
            System.Diagnostics.Debug.WriteLine($"Images count: {productVM.Images?.Count ?? 0}");
            System.Diagnostics.Debug.WriteLine($"ImageColors count: {productVM.ImageColors?.Count ?? 0}");
            System.Diagnostics.Debug.WriteLine($"ExistingImagePaths count: {ExistingImagePaths?.Count ?? 0}");
            System.Diagnostics.Debug.WriteLine($"ExistingImageIds count: {ExistingImageIds?.Count ?? 0}");

            // Debug the received form data
            if (ExistingImagePaths != null)
            {
                for (int i = 0; i < ExistingImagePaths.Count; i++)
                {
                    System.Diagnostics.Debug.WriteLine($"ExistingImagePaths[{i}]: '{ExistingImagePaths[i]}'");
                }
            }
            
            if (productVM.ImageColors != null)
            {
                for (int i = 0; i < productVM.ImageColors.Count; i++)
                {
                    System.Diagnostics.Debug.WriteLine($"productVM.ImageColors[{i}]: '{productVM.ImageColors[i]}'");
                }
            }

            if (!ModelState.IsValid)
            {
                var errors = ModelState
                    .Where(x => x.Value.Errors.Count > 0)
                    .Select(x => $"{x.Key}: {string.Join(", ", x.Value.Errors.Select(e => e.ErrorMessage))}")
                    .ToList();
                
                TempData["Error"] = "يرجى تصحيح الأخطاء التالية: " + string.Join(" | ", errors);
                
                var existingProduct = _untiOfWork.Product.GetFirstorDefault(x => x.Id == productVM.product.Id, "ProductImages");
                if (existingProduct != null)
                {
                    productVM.product = existingProduct;
                }
                
                productVM.categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString(),
                    Selected = x.Id == productVM.product.CategoryId
                });
                productVM.AvailableColors = GetAvailableColors();

                return View(productVM);
            }

            try
            {
                string RootPath = _webHostEnvironment.WebRootPath;
                var existingProduct = _untiOfWork.Product.GetFirstorDefault(x => x.Id == productVM.product.Id, "ProductImages");
                
                if (existingProduct == null)
                {
                    TempData["Error"] = "المنتج غير موجود";
                    return RedirectToAction("Index");
                }

                System.Diagnostics.Debug.WriteLine($"Found existing product: {existingProduct.Name}");
                System.Diagnostics.Debug.WriteLine($"Existing product has {existingProduct.ProductImages?.Count ?? 0} ProductImages");

                // تحديث الخصائص الأساسية
                existingProduct.Name = productVM.product.Name;
                existingProduct.Price = productVM.product.Price;
                existingProduct.CategoryId = productVM.product.CategoryId;
                existingProduct.Color = productVM.product.Color;
                existingProduct.Size = productVM.product.Size;
                existingProduct.IsOneSize = productVM.product.IsOneSize;

                if (productVM.product.IsOneSize)
                {
                    existingProduct.Size = "One Size";
                }

                // تحديث الصورة الرئيسية
                if (Img != null && Img.Length > 0)
                {
                    System.Diagnostics.Debug.WriteLine("Updating main image");
                    
                    if (!string.IsNullOrEmpty(existingProduct.Img))
                    {
                        DeleteImage(existingProduct.Img, RootPath);
                    }
                    
                    var newImagePath = SaveImage(Img, RootPath);
                    existingProduct.Img = newImagePath;
                }

                // تحديث الصور الإضافية - منطق محسن لحفظ البيانات
                System.Diagnostics.Debug.WriteLine("Processing additional images with improved logic");
                
                // تحقق من وجود أي بيانات صور في النموذج
                bool hasNewImages = productVM.Images != null && productVM.Images.Any(img => img != null && img.Length > 0);
                bool hasImageColors = productVM.ImageColors != null && productVM.ImageColors.Any(c => !string.IsNullOrEmpty(c));
                bool hasExistingPaths = ExistingImagePaths != null && ExistingImagePaths.Any(p => !string.IsNullOrEmpty(p));
                
                // إضافة فحص إضافي للتأكد من أن لدينا ProductImages في قاعدة البيانات
                bool hasExistingProductImages = existingProduct.ProductImages != null && existingProduct.ProductImages.Any();
                
                System.Diagnostics.Debug.WriteLine($"Image form data check:");
                System.Diagnostics.Debug.WriteLine($"  hasNewImages: {hasNewImages}");
                System.Diagnostics.Debug.WriteLine($"  hasImageColors: {hasImageColors}");
                System.Diagnostics.Debug.WriteLine($"  hasExistingPaths: {hasExistingPaths}");
                System.Diagnostics.Debug.WriteLine($"  hasExistingProductImages: {hasExistingProductImages}");

                // إذا كان لدينا ProductImages موجودة ولكن لا توجد بيانات نموذج، فهذا يعني أن المستخدم لم يغير الصور
                if (hasExistingProductImages && !hasNewImages && !hasImageColors && !hasExistingPaths)
                {
                    System.Diagnostics.Debug.WriteLine("ProductImages exist but no form data submitted - preserving existing ProductImages unchanged");
                    // لا تفعل شيئًا مع ProductImages - احتفظ بها كما هي
                }
                else if (hasNewImages || hasImageColors || hasExistingPaths)
                {
                    // إذا كانت هناك بيانات صور في النموذج، قم بمعالجتها
                    System.Diagnostics.Debug.WriteLine("Form data detected - processing ProductImages");
                    ProcessProductImagesWithExistingData(existingProduct, productVM.Images, productVM.ImageColors, ExistingImagePaths, ExistingImageIds, RootPath);
                }
                else
                {
                    System.Diagnostics.Debug.WriteLine("No image data detected and no existing ProductImages - leaving ProductImages empty");
                    // لا توجد صور جديدة ولا صور موجودة
                }

                _untiOfWork.Product.Update(existingProduct);
                var result = _untiOfWork.Complete();
                
                System.Diagnostics.Debug.WriteLine($"Save result: {result}");
                System.Diagnostics.Debug.WriteLine($"Final ProductImages count: {existingProduct.ProductImages?.Count ?? 0}");
                
                if (result > 0)
                {
                    TempData["Success"] = "تم تحديث المنتج بنجاح";
                    return RedirectToAction("Index");
                }
                else
                {
                    TempData["Error"] = "فشل في حفظ التغييرات";
                    
                    productVM.product = existingProduct;
                    productVM.categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                    {
                        Text = x.Name,
                        Value = x.Id.ToString(),
                        Selected = x.Id == productVM.product.CategoryId
                    });
                    productVM.AvailableColors = GetAvailableColors();
                    return View(productVM);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Edit POST Error: {ex.Message}");
                
                TempData["Error"] = "حدث خطأ أثناء تحديث المنتج: " + ex.Message;
                
                var existingProduct = _untiOfWork.Product.GetFirstorDefault(x => x.Id == productVM.product.Id, "ProductImages");
                if (existingProduct != null)
                {
                    productVM.product = existingProduct;
                }
                
                productVM.categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString(),
                    Selected = x.Id == productVM.product.CategoryId
                });
                productVM.AvailableColors = GetAvailableColors();
                return View(productVM);
            }
        }

        [HttpDelete]
        public IActionResult DeleteProduct(int? id)
        {
            try
            {
                var product = _untiOfWork.Product.GetFirstorDefault(x => x.Id == id, "ProductImages");
                if (product == null)
                {
                    return Json(new { success = false, message = "المنتج غير موجود" });
                }

                string RootPath = _webHostEnvironment.WebRootPath;

                if (!string.IsNullOrEmpty(product.Img))
                {
                    DeleteImage(product.Img, RootPath);
                }

                if (product.ProductImages != null && product.ProductImages.Any())
                {
                    foreach (var img in product.ProductImages)
                    {
                        if (!string.IsNullOrEmpty(img.ImagePath))
                        {
                            DeleteImage(img.ImagePath, RootPath);
                        }
                    }
                }

                _untiOfWork.Product.Remove(product);
                _untiOfWork.Complete();
                
                return Json(new { success = true, message = "تم حذف المنتج بنجاح" });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "حدث خطأ أثناء حذف المنتج: " + ex.Message });
            }
        }

        [HttpGet]
        public IActionResult TestProductImages(int id)
        {
            // Test method to check ProductImages
            var product = _context.products.Include(p => p.ProductImages).FirstOrDefault(p => p.Id == id);
            
            if (product == null)
            {
                return Json(new { error = "Product not found" });
            }

            var result = new
            {
                ProductId = product.Id,
                ProductName = product.Name,
                MainImage = product.Img,
                ProductImagesCount = product.ProductImages?.Count ?? 0,
                ProductImages = product.ProductImages?.Select(pi => new { 
                    Id = pi.Id, 
                    Path = pi.ImagePath, 
                    Color = pi.Color,
                    FullPath = "/" + pi.ImagePath?.Replace("\\", "/")
                }).ToList(),
                AvailableColors = product.ProductImages?.Where(pi => !string.IsNullOrEmpty(pi.Color))
                    .Select(pi => pi.Color).Distinct().ToList(),
                Message = product.ProductImages?.Any() == true ? "Product has images" : "No ProductImages found"
            };

            return Json(result);
        }

        [HttpGet]
        public IActionResult DebugProduct(int id)
        {
            // Debug method to get detailed product information
            var product = _context.products
                .Include(p => p.ProductImages)
                .Include(p => p.Category)
                .FirstOrDefault(p => p.Id == id);
            
            if (product == null)
            {
                return Json(new { error = "Product not found" });
            }

            return Json(new
            {
                Product = new
                {
                    Id = product.Id,
                    Name = product.Name,
                    Price = product.Price,
                    MainImage = product.Img,
                    Color = product.Color,
                    Size = product.Size,
                    IsOneSize = product.IsOneSize,
                    CategoryName = product.Category?.Name
                },
                ProductImages = product.ProductImages?.Select(pi => new {
                    Id = pi.Id,
                    ImagePath = pi.ImagePath,
                    Color = pi.Color,
                    ProductId = pi.ProductId
                }).ToList(),
                Summary = new
                {
                    TotalImages = product.ProductImages?.Count ?? 0,
                    UniqueColors = product.ProductImages?.Where(pi => !string.IsNullOrEmpty(pi.Color))
                        .Select(pi => pi.Color.Trim()).Distinct().Count() ?? 0,
                    HasMainImage = !string.IsNullOrEmpty(product.Img)
                }
            });
        }
        #region Helper Methods

        private List<SelectListItem> GetAvailableColors()
        {
            return new List<SelectListItem>
            {
                new SelectListItem { Text = "Black", Value = "black" },
                new SelectListItem { Text = "White", Value = "white" },
                new SelectListItem { Text = "Red", Value = "red" },
                new SelectListItem { Text = "Blue", Value = "blue" },
                new SelectListItem { Text = "Green", Value = "green" },
                new SelectListItem { Text = "Yellow", Value = "yellow" },
                new SelectListItem { Text = "Pink", Value = "pink" },
                new SelectListItem { Text = "Brown", Value = "brown" },
                new SelectListItem { Text = "Gray", Value = "gray" },
                new SelectListItem { Text = "Purple", Value = "purple" },
                new SelectListItem { Text = "Orange", Value = "orange" },
                new SelectListItem { Text = "Burgundy", Value = "burgundy" },
                new SelectListItem { Text = "Gold", Value = "gold" },
                new SelectListItem { Text = "Silver", Value = "silver" },
                new SelectListItem { Text = "Navy", Value = "navy" },
                new SelectListItem { Text = "Olive", Value = "olive" }
            };
        }

        private string SaveImage(IFormFile image, string rootPath)
        {
            if (image == null || image.Length == 0)
                return null;

            string filename = Guid.NewGuid().ToString();
            var ext = Path.GetExtension(image.FileName);
            var uploadPath = Path.Combine(rootPath, "Images", "Products");
            
            if (!Directory.Exists(uploadPath))
                Directory.CreateDirectory(uploadPath);
            
            var filePath = Path.Combine(uploadPath, filename + ext);
            
            using (var filestream = new FileStream(filePath, FileMode.Create))
            {
                image.CopyTo(filestream);
            }
            
            return Path.Combine("Images", "Products", filename + ext).Replace("\\", "/");
        }

        private void DeleteImage(string imagePath, string rootPath)
        {
            if (string.IsNullOrEmpty(imagePath))
                return;

            var fullPath = Path.Combine(rootPath, imagePath.Replace("/", Path.DirectorySeparatorChar.ToString()));
            if (System.IO.File.Exists(fullPath))
            {
                try
                {
                    System.IO.File.Delete(fullPath);
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"Failed to delete image {fullPath}: {ex.Message}");
                }
            }
        }

        private List<ProductImage> ProcessAdditionalImages(List<IFormFile> images, List<string> imageColors, string rootPath)
        {
            var productImages = new List<ProductImage>();
            
            if (images == null || !images.Any())
                return productImages;

            var uploadPath = Path.Combine(rootPath, "Images", "Products");
            if (!Directory.Exists(uploadPath))
                Directory.CreateDirectory(uploadPath);

            for (int i = 0; i < images.Count; i++)
            {
                var image = images[i];
                if (image != null && image.Length > 0)
                {
                    var imagePath = SaveImage(image, rootPath);
                    
                    string color = "";
                    if (imageColors != null && i < imageColors.Count)
                    {
                        color = imageColors[i];
                    }

                    productImages.Add(new ProductImage
                    {
                        ImagePath = imagePath,
                        Color = color
                    });
                }
            }

            return productImages;
        }

        /// <summary>
        /// معالجة تحديثات الصور مع دعم الصور الموجودة - نسخة محسنة
        /// </summary>
        private void ProcessProductImagesWithExistingData(Product existingProduct, List<IFormFile> newImages, List<string> imageColors, List<string> existingImagePaths, List<int> existingImageIds, string rootPath)
        {
            System.Diagnostics.Debug.WriteLine("=== ProcessProductImagesWithExistingData Started (Enhanced) ===");
            System.Diagnostics.Debug.WriteLine($"Input - newImages: {newImages?.Count ?? 0}, imageColors: {imageColors?.Count ?? 0}");
            System.Diagnostics.Debug.WriteLine($"Input - existingImagePaths: {existingImagePaths?.Count ?? 0}, existingImageIds: {existingImageIds?.Count ?? 0}");
            
            // احفظ نسخة من ProductImages الحالية قبل المسح
            var currentProductImages = existingProduct.ProductImages?.ToList() ?? new List<ProductImage>();
            System.Diagnostics.Debug.WriteLine($"Current ProductImages in DB: {currentProductImages.Count}");
            
            // Check for any actual form data
            bool hasFormImages = newImages != null && newImages.Any(img => img != null && img.Length > 0);
            bool hasFormColors = imageColors != null && imageColors.Any(c => !string.IsNullOrEmpty(c));
            bool hasFormExisting = existingImagePaths != null && existingImagePaths.Any(p => !string.IsNullOrEmpty(p));
            
            System.Diagnostics.Debug.WriteLine($"Form data check - hasFormImages: {hasFormImages}, hasFormColors: {hasFormColors}, hasFormExisting: {hasFormExisting}");
            
            // If no form data and we have existing images, keep them
            if (!hasFormImages && !hasFormColors && !hasFormExisting && currentProductImages.Any())
            {
                System.Diagnostics.Debug.WriteLine("No form data submitted but existing images found - keeping existing ProductImages intact");
                return; // احتفظ بـ ProductImages كما هي
            }

            // امسح مجموعة الصور الموجودة فقط إذا كانت هناك بيانات نموذج أو لا توجد صور حالية
            if (existingProduct.ProductImages != null)
            {
                existingProduct.ProductImages.Clear();
            }
            else
            {
                existingProduct.ProductImages = new List<ProductImage>();
            }

            // إذا كان لدينا صور موجودة ولكن لا توجد بيانات نموذج، أعد إنشاؤها
            if (!hasFormImages && !hasFormColors && !hasFormExisting && currentProductImages.Any())
            {
                System.Diagnostics.Debug.WriteLine("Restoring existing ProductImages");
                foreach (var currentImg in currentProductImages)
                {
                    existingProduct.ProductImages.Add(new ProductImage
                    {
                        ImagePath = currentImg.ImagePath,
                        Color = currentImg.Color,
                        ProductId = existingProduct.Id
                    });
                }
                return;
            }

            // حدد العدد الأقصى للصفوف للمعالجة
            int maxCount = Math.Max(
                Math.Max(newImages?.Count ?? 0, imageColors?.Count ?? 0),
                Math.Max(existingImagePaths?.Count ?? 0, currentProductImages.Count)
            );

            System.Diagnostics.Debug.WriteLine($"Processing {maxCount} image entries");

            // معالجة كل صف من النموذج
            for (int i = 0; i < maxCount; i++)
            {
                var hasNewImage = newImages != null && i < newImages.Count && newImages[i] != null && newImages[i].Length > 0;
                var hasExistingPath = existingImagePaths != null && i < existingImagePaths.Count && !string.IsNullOrEmpty(existingImagePaths[i]);
                var hasColor = imageColors != null && i < imageColors.Count && !string.IsNullOrEmpty(imageColors[i]);
                var hasCurrentImage = i < currentProductImages.Count;

                // احصل على اللون - استخدم اللون المرسل أو اللون الحالي
                string color = "";
                if (hasColor)
                {
                    color = imageColors[i];
                }
                else if (hasCurrentImage)
                {
                    color = currentProductImages[i].Color ?? "";
                }

                System.Diagnostics.Debug.WriteLine($"Row {i}: hasNewImage={hasNewImage}, hasExistingPath={hasExistingPath}, hasColor={hasColor}, hasCurrentImage={hasCurrentImage}");
                System.Diagnostics.Debug.WriteLine($"  Color value: '{color}'");

                if (hasNewImage)
                {
                    // ارفع صورة جديدة
                    var imagePath = SaveImage(newImages[i], rootPath);
                    System.Diagnostics.Debug.WriteLine($"  Adding new image: {imagePath}");

                    existingProduct.ProductImages.Add(new ProductImage
                    {
                        ImagePath = imagePath,
                        Color = color,
                        ProductId = existingProduct.Id
                    });
                }
                else if (hasExistingPath)
                {
                    // استخدم مسار الصورة الموجود من النموذج
                    System.Diagnostics.Debug.WriteLine($"  Using existing path from form: {existingImagePaths[i]}");

                    existingProduct.ProductImages.Add(new ProductImage
                    {
                        ImagePath = existingImagePaths[i],
                        Color = color,
                        ProductId = existingProduct.Id
                    });
                }
                else if (hasCurrentImage)
                {
                    // استخدم الصورة الحالية من قاعدة البيانات كاحتياطي
                    var currentImg = currentProductImages[i];
                    System.Diagnostics.Debug.WriteLine($"  Using current image from DB: {currentImg.ImagePath}");

                    existingProduct.ProductImages.Add(new ProductImage
                    {
                        ImagePath = currentImg.ImagePath,
                        Color = hasColor ? color : currentImg.Color, // استخدم اللون الجديد إذا تم تقديمه، وإلا احتفظ بالحالي
                        ProductId = existingProduct.Id
                    });
                }
            }

            System.Diagnostics.Debug.WriteLine($"=== ProcessProductImagesWithExistingData Complete - Final count: {existingProduct.ProductImages.Count} images ===");
            
            // تسجيل النتائج النهائية
            foreach (var img in existingProduct.ProductImages)
            {
                System.Diagnostics.Debug.WriteLine($"  Final image: Path={img.ImagePath}, Color={img.Color}");
            }
        }

        #endregion

        [HttpGet]
        public IActionResult DebugFormData()
        {
            // Simple method to test form submission
            return View();
        }

        [HttpPost] 
        public IActionResult DebugFormData(IFormCollection form)
        {
            var result = new
            {
                FormKeys = form.Keys.ToList(),
                FormData = form.ToDictionary(kvp => kvp.Key, kvp => kvp.Value.ToString()),
                ExistingImagePaths = form["ExistingImagePaths"].ToList(),
                ImageColors = form["ImageColors"].ToList(),
                ExistingImageIds = form["ExistingImageIds"].ToList()
            };

            return Json(result);
        }
    }
}