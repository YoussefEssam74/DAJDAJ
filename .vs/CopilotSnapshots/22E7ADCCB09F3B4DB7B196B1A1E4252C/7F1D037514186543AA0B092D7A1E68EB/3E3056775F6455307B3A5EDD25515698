using DAJDAJ.DataAccess;
using DAJDAJ.DataAccess.Implementation;
using DAJDAJ.Entities.Models;
using DAJDAJ.Entities.Repositories;
using DAJDAJ.Entities.ViewModels;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Threading.Tasks;

namespace DAJDAJ.Web.Areas.Admin.Controllers
{
    [Area("Admin")]
    public class ProductController : Controller
    {
        private readonly IUntiOfWork _untiOfWork;
        private readonly IWebHostEnvironment _webHostEnvironment;
        private readonly ApplicationDbContext _context;

        public ProductController(
            IUntiOfWork untiOfWork,
            IWebHostEnvironment webHostEnvironment,
            ApplicationDbContext context)
        {
            _untiOfWork = untiOfWork;
            _webHostEnvironment = webHostEnvironment;
            _context = context;
        }

        public IActionResult Index()
        {
            return View();
        }

        public IActionResult GetData()
        {
            var products = _untiOfWork.Product.GetAll(Includeword: "Category");
            return Json(new { data = products });
        }

        [HttpGet]
        public IActionResult Create()
        {
            ProductVM productVM = new ProductVM()
            {
                product = new Product(),
                categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString()
                }),
                AvailableColors = GetAvailableColors(),
                Images = new List<IFormFile>(),
                ImageColors = new List<string>()
            };

            return View(productVM);
        }

        [HttpPost]
        [AutoValidateAntiforgeryToken]
        public IActionResult Create(ProductVM productVM, IFormFile Img)
        {
            if (!ModelState.IsValid)
            {
                var errors = ModelState.Values
                    .SelectMany(v => v.Errors)
                    .Select(e => e.ErrorMessage)
                    .ToList();

                TempData["Error"] = "Please correct the following errors: " + string.Join(", ", errors);

                productVM.categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString()
                });
                productVM.AvailableColors = GetAvailableColors();

                return View(productVM);
            }

            try
            {
                string RootPath = _webHostEnvironment.WebRootPath;

                // Process main image
                if (Img != null && Img.Length > 0)
                {
                    var mainImagePath = SaveImage(Img, RootPath);
                    productVM.product.Img = mainImagePath;
                }

                // Process additional images
                if (productVM.Images != null && productVM.Images.Any(img => img != null && img.Length > 0))
                {
                    var productImages = ProcessAdditionalImages(
                        productVM.Images,
                        productVM.ImageColors,
                        RootPath
                    );

                    productVM.product.ProductImages = productImages;
                }

                // Handle one size option
                if (productVM.product.IsOneSize)
                {
                    productVM.product.Size = "One Size";
                }

                // Add product to database
                _untiOfWork.Product.Add(productVM.product);
                int result = _untiOfWork.Complete();

                if (result > 0)
                {
                    TempData["Success"] = "Product created successfully";
                    return RedirectToAction("Index");
                }
                else
                {
                    TempData["Error"] = "Failed to save product";
                    return View(productVM);
                }
            }
            catch (Exception ex)
            {
                TempData["Error"] = "Error creating product: " + ex.Message;

                // Rebind dropdowns
                productVM.categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString()
                });
                productVM.AvailableColors = GetAvailableColors();

                return View(productVM);
            }
        }

        [HttpGet]
        public IActionResult Edit(int? id)
        {
            if (id == null || id == 0)
            {
                TempData["Error"] = "Invalid product ID";
                return RedirectToAction("Index");
            }

            // Load product with related data
            var product = _context.products
                .Include(p => p.Category)
                .Include(p => p.ProductImages)
                .FirstOrDefault(p => p.Id == id);

            if (product == null)
            {
                TempData["Error"] = "Product not found";
                return RedirectToAction("Index");
            }

            ProductVM productVM = new ProductVM()
            {
                product = product,
                categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString(),
                    Selected = x.Id == product.CategoryId
                }),
                AvailableColors = GetAvailableColors(),
                Images = new List<IFormFile>(),
                ImageColors = new List<string>(),
                ExistingImagePaths = product.ProductImages?.Select(pi => pi.ImagePath).ToList() ?? new List<string>(),
                ExistingImageIds = product.ProductImages?.Select(pi => pi.Id).ToList() ?? new List<int>()
            };

            return View(productVM);
        }

        [HttpPost]
        [AutoValidateAntiforgeryToken]
        public IActionResult Edit(ProductVM productVM, IFormFile Img, List<string> ExistingImagePaths, List<int> ExistingImageIds)
        {
            ModelState.Remove("product.Img");
            ModelState.Remove("Img");

            // Debug logging
            Debug.WriteLine("=== Edit POST Started ===");
            Debug.WriteLine($"Product ID: {productVM.product.Id}");
            Debug.WriteLine($"Images count: {productVM.Images?.Count ?? 0}");
            Debug.WriteLine($"ImageColors count: {productVM.ImageColors?.Count ?? 0}");
            Debug.WriteLine($"ExistingImagePaths count: {ExistingImagePaths?.Count ?? 0}");
            Debug.WriteLine($"ExistingImageIds count: {ExistingImageIds?.Count ?? 0}");

            // Log received data
            if (productVM.Images != null)
            {
                for (int i = 0; i < productVM.Images.Count; i++)
                {
                    var img = productVM.Images[i];
                    Debug.WriteLine($"Image[{i}]: {(img != null && img.Length > 0 ? img.FileName : "null/empty")}");
                }
            }

            if (productVM.ImageColors != null)
            {
                for (int i = 0; i < productVM.ImageColors.Count; i++)
                {
                    Debug.WriteLine($"ImageColor[{i}]: '{productVM.ImageColors[i]}'");
                }
            }

            if (!ModelState.IsValid)
            {
                var errors = ModelState
                    .Where(x => x.Value.Errors.Count > 0)
                    .Select(x => $"{x.Key}: {string.Join(", ", x.Value.Errors.Select(e => e.ErrorMessage))}")
                    .ToList();

                TempData["Error"] = "Please correct the following errors: " + string.Join(" | ", errors);

                // Rebind data
                productVM.categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString(),
                    Selected = x.Id == productVM.product.CategoryId
                });
                productVM.AvailableColors = GetAvailableColors();

                return View(productVM);
            }

            try
            {
                string RootPath = _webHostEnvironment.WebRootPath;
                var existingProduct = _untiOfWork.Product.GetFirstorDefault(
                    x => x.Id == productVM.product.Id,
                    "ProductImages"
                );

                if (existingProduct == null)
                {
                    TempData["Error"] = "Product not found";
                    return RedirectToAction("Index");
                }

                Debug.WriteLine($"Found existing product: {existingProduct.Name}");
                Debug.WriteLine($"Current ProductImages count: {existingProduct.ProductImages?.Count ?? 0}");

                // Update basic properties
                existingProduct.Name = productVM.product.Name;
                existingProduct.Price = productVM.product.Price;
                existingProduct.CategoryId = productVM.product.CategoryId;
                existingProduct.Color = productVM.product.Color;
                existingProduct.Size = productVM.product.Size;
                existingProduct.IsOneSize = productVM.product.IsOneSize;

                if (existingProduct.IsOneSize)
                {
                    existingProduct.Size = "One Size";
                }

                // Update main image
                if (Img != null && Img.Length > 0)
                {
                    Debug.WriteLine("Updating main image");
                    
                    // Delete old main image if exists
                    if (!string.IsNullOrEmpty(existingProduct.Img))
                    {
                        DeleteImage(existingProduct.Img, RootPath);
                    }

                    var newImagePath = SaveImage(Img, RootPath);
                    existingProduct.Img = newImagePath;
                }

                // Process additional images
                ProcessProductImagesForEdit(
                    existingProduct,
                    productVM.Images,
                    productVM.ImageColors,
                    ExistingImagePaths,
                    ExistingImageIds,
                    RootPath
                );

                // Update product
                _untiOfWork.Product.Update(existingProduct);
                int result = _untiOfWork.Complete();

                Debug.WriteLine($"Save result: {result}");
                Debug.WriteLine($"Final ProductImages count: {existingProduct.ProductImages?.Count ?? 0}");

                if (result > 0)
                {
                    TempData["Success"] = "Product updated successfully";
                    return RedirectToAction("Index");
                }
                else
                {
                    TempData["Error"] = "Failed to update product";
                    return View(productVM);
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Edit POST Error: {ex.Message}");
                Debug.WriteLine($"Stack Trace: {ex.StackTrace}");
                
                TempData["Error"] = "Error updating product: " + ex.Message;

                // Rebind data
                productVM.categorylist = _untiOfWork.Category.GetAll().Select(x => new SelectListItem
                {
                    Text = x.Name,
                    Value = x.Id.ToString(),
                    Selected = x.Id == productVM.product.CategoryId
                });
                productVM.AvailableColors = GetAvailableColors();

                return View(productVM);
            }
        }

        [HttpDelete]
        public IActionResult DeleteProduct(int? id)
        {
            try
            {
                var product = _untiOfWork.Product.GetFirstorDefault(x => x.Id == id, "ProductImages");
                if (product == null)
                {
                    return Json(new { success = false, message = "Product not found" });
                }

                string RootPath = _webHostEnvironment.WebRootPath;

                // Delete main image
                if (!string.IsNullOrEmpty(product.Img))
                {
                    DeleteImage(product.Img, RootPath);
                }

                // Delete additional images
                if (product.ProductImages != null && product.ProductImages.Any())
                {
                    foreach (var img in product.ProductImages)
                    {
                        if (!string.IsNullOrEmpty(img.ImagePath))
                        {
                            DeleteImage(img.ImagePath, RootPath);
                        }
                    }
                }

                // Delete product
                _untiOfWork.Product.Remove(product);
                _untiOfWork.Complete();

                return Json(new { success = true, message = "Product deleted successfully" });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "Error deleting product: " + ex.Message });
            }
        }

        #region Helper Methods

        private List<SelectListItem> GetAvailableColors()
        {
            return new List<SelectListItem>
            {
                new SelectListItem { Text = "Black", Value = "black" },
                new SelectListItem { Text = "White", Value = "white" },
                new SelectListItem { Text = "Red", Value = "red" },
                new SelectListItem { Text = "Blue", Value = "blue" },
                new SelectListItem { Text = "Green", Value = "green" },
                new SelectListItem { Text = "Yellow", Value = "yellow" },
                new SelectListItem { Text = "Pink", Value = "pink" },
                new SelectListItem { Text = "Brown", Value = "brown" },
                new SelectListItem { Text = "Gray", Value = "gray" },
                new SelectListItem { Text = "Purple", Value = "purple" },
                new SelectListItem { Text = "Orange", Value = "orange" },
                new SelectListItem { Text = "Burgundy", Value = "burgundy" },
                new SelectListItem { Text = "Gold", Value = "gold" },
                new SelectListItem { Text = "Silver", Value = "silver" },
                new SelectListItem { Text = "Navy", Value = "navy" },
                new SelectListItem { Text = "Olive", Value = "olive" }
            };
        }

        private string SaveImage(IFormFile image, string rootPath)
        {
            if (image == null || image.Length == 0)
                return null;

            string filename = Guid.NewGuid().ToString() + Path.GetExtension(image.FileName);
            var uploadPath = Path.Combine(rootPath, "Images", "Products");

            if (!Directory.Exists(uploadPath))
                Directory.CreateDirectory(uploadPath);

            var filePath = Path.Combine(uploadPath, filename);

            using (var filestream = new FileStream(filePath, FileMode.Create))
            {
                image.CopyTo(filestream);
            }

            return Path.Combine("Images", "Products", filename).Replace("\\", "/");
        }

        private void DeleteImage(string imagePath, string rootPath)
        {
            if (string.IsNullOrEmpty(imagePath))
                return;

            var fullPath = Path.Combine(rootPath, imagePath);
            if (System.IO.File.Exists(fullPath))
            {
                try
                {
                    System.IO.File.Delete(fullPath);
                }
                catch (Exception ex)
                {
                    Debug.WriteLine($"Failed to delete image: {ex.Message}");
                }
            }
        }

        private List<ProductImage> ProcessAdditionalImages(
            List<IFormFile> images,
            List<string> imageColors,
            string rootPath)
        {
            var productImages = new List<ProductImage>();

            if (images == null || !images.Any(img => img != null && img.Length > 0))
                return productImages;

            for (int i = 0; i < images.Count; i++)
            {
                var image = images[i];
                if (image != null && image.Length > 0)
                {
                    var imagePath = SaveImage(image, rootPath);

                    string color = "";
                    if (imageColors != null && i < imageColors.Count)
                    {
                        color = imageColors[i];
                    }

                    productImages.Add(new ProductImage
                    {
                        ImagePath = imagePath,
                        Color = color
                    });
                }
            }

            return productImages;
        }

        // Improved method to handle both existing and new images properly
        private void ProcessProductImagesForEdit(
            Product existingProduct,
            List<IFormFile?> newImages,
            List<string> imageColors,
            List<string> existingImagePaths,
            List<int> existingImageIds,
            string rootPath)
        {
            Debug.WriteLine("=== ProcessProductImagesForEdit Started ===");
            Debug.WriteLine($"New Images Count: {newImages?.Count ?? 0}");
            Debug.WriteLine($"Image Colors Count: {imageColors?.Count ?? 0}");
            Debug.WriteLine($"Existing Image Paths Count: {existingImagePaths?.Count ?? 0}");
            Debug.WriteLine($"Current ProductImages Count: {existingProduct.ProductImages?.Count ?? 0}");

            // Backup current images
            var currentImages = existingProduct.ProductImages?.ToList() ?? new List<ProductImage>();
            
            // Clear the collection to rebuild it
            if (existingProduct.ProductImages != null)
            {
                existingProduct.ProductImages.Clear();
            }
            else
            {
                existingProduct.ProductImages = new List<ProductImage>();
            }

            // Process existing images that should be kept
            if (existingImagePaths != null && existingImagePaths.Any())
            {
                for (int i = 0; i < existingImagePaths.Count; i++)
                {
                    var existingPath = existingImagePaths[i];
                    if (!string.IsNullOrEmpty(existingPath))
                    {
                        // Find the original image
                        var originalImage = currentImages.FirstOrDefault(img => img.ImagePath == existingPath);
                        if (originalImage != null)
                        {
                            // Keep existing image but update color if provided
                            string updatedColor = originalImage.Color ?? "";
                            if (imageColors != null && i < imageColors.Count && !string.IsNullOrEmpty(imageColors[i]))
                            {
                                updatedColor = imageColors[i];
                            }

                            existingProduct.ProductImages.Add(new ProductImage
                            {
                                ImagePath = originalImage.ImagePath,
                                Color = updatedColor,
                                ProductId = existingProduct.Id
                            });

                            Debug.WriteLine($"Kept existing image: {originalImage.ImagePath} with color: {updatedColor}");
                        }
                    }
                }
            }

            // Process new images
            if (newImages != null && newImages.Any())
            {
                for (int i = 0; i < newImages.Count; i++)
                {
                    var image = newImages[i];
                    if (image != null && image.Length > 0)
                    {
                        var imagePath = SaveImage(image, rootPath);
                        if (!string.IsNullOrEmpty(imagePath))
                        {
                            string color = "";
                            
                            // Calculate the color index - need to account for existing images
                            int colorIndex = (existingImagePaths?.Count ?? 0) + i;
                            if (imageColors != null && colorIndex < imageColors.Count)
                            {
                                color = imageColors[colorIndex];
                            }

                            existingProduct.ProductImages.Add(new ProductImage
                            {
                                ImagePath = imagePath,
                                Color = color,
                                ProductId = existingProduct.Id
                            });

                            Debug.WriteLine($"Added new image: {imagePath} with color: {color}");
                        }
                    }
                }
            }

            Debug.WriteLine($"Final ProductImages Count: {existingProduct.ProductImages.Count}");
            Debug.WriteLine("=== ProcessProductImagesForEdit Completed ===");
        }

        #endregion
    }
}